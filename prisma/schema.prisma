// Prisma Schema for Beexel AI Render Portal V2
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // Note: directUrl removed - using pooled connection for migrations
  // The direct connection (5432) is blocked/unavailable
}

// Redemption Codes
model Code {
  id                String   @id @default(cuid())
  code              String   @unique @db.VarChar(5)
  tokens            Int      @default(0)
  remainingTokens   Int      @default(0)
  isRevoked         Boolean  @default(false)
  phoneNumber       String?  @db.VarChar(20)
  amount            Decimal? @db.Decimal(10, 2)
  mpesaReceipt      String?  @db.VarChar(50)
  createdAt         DateTime @default(now())
  createdBy         String?
  autoGenerated     Boolean  @default(false)
  renderCount       Int      @default(0)
  usageHistory      Json?    // Array of usage records

  transactions      Transaction[]
  usageHistoryItems CodeUsageHistory[]

  @@index([phoneNumber])
  @@index([createdAt])
  @@map("codes")
}

// User Tokens
model UserToken {
  id            String   @id @default(cuid())
  userId        String   @unique
  fingerprint   String?  // Device fingerprint for security
  totalTokens   Float    @default(0)
  usedTokens    Float    @default(0)
  balance       Float    @default(0)
  transactionHistory  Json?    // Array of transaction records
  redeemedCodes Json?    // Array of code strings
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  transactions  Transaction[]
  jobs         Job[]

  @@index([userId])
  @@index([fingerprint])
  @@map("user_tokens")
}

// Transactions (M-PESA Payments)
model Transaction {
  id                String   @id @default(cuid())
  invoiceId         String?  @unique
  amount            Decimal  @db.Decimal(10, 2)
  mpesaNumber       String
  email             String?
  userId            String?
  tokens            Int?
  status            String   @default("pending") // pending, completed, failed, cancelled
  redemptionCodeId  String?
  mpesaReceipt      String?
  stkRequestId      String?
  apiRef            String?
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  paymentReceivedAt DateTime?
  lastCheckedAt     DateTime?
  codeGeneratedAt   DateTime?
  codeGeneratedBy   String?
  // Failure tracking for customer support
  failureReason     String?  @db.Text  // Why the transaction failed
  failedAt          DateTime?          // When it failed
  attempts          Int      @default(1) // Number of retry attempts

  code              Code?    @relation(fields: [redemptionCodeId], references: [id])
  userToken         UserToken? @relation(fields: [userId], references: [userId])

  @@index([status])
  @@index([invoiceId])
  @@index([userId])
  @@index([mpesaReceipt])
  @@index([mpesaNumber])
  @@map("transactions")
}

// Rendering Jobs
model Job {
  id            String   @id @default(cuid())
  taskId        String?  @unique
  userId        String
  prompt        String?  @db.Text
  enhancedPrompt String? @db.Text
  model         String?  @default("nano-banana-pro") // flux-pro, nano-banana-pro
  aspect        String?
  resolution    String?
  mode          String?
  denoise       Decimal? @db.Decimal(5, 2)
  seed          Int?
  treeGroup     String?
  uploadedImage String?  @db.Text
  status        String   @default("pending") // pending, processing, success, failed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  resultUrls    Json?    // Array of URLs
  apiResponse   Json?
  apiResult     Json?
  errorMessage  String?  @db.Text

  userToken     UserToken @relation(fields: [userId], references: [userId])

  @@index([userId])
  @@index([status])
  @@map("jobs")
}

// Uploaded Files
model Upload {
  id              String   @id @default(cuid())
  filename        String
  originalFilename String?
  filePath        String   @unique
  fileSize        Int?
  mimeType        String?
  directory       String   @default("uploads")
  userId          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([directory])
  @@map("uploads")
}

// Admin Users
model AdminUser {
  id                String   @id @default(cuid())
  username          String   @unique
  name              String?
  passwordHash      String
  mothersMaidenName String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastLoginAt       DateTime?

  @@map("admin_users")
}

// Admin Sessions (for persistent login)
model AdminSession {
  id        String   @id @default(cuid())
  token     String   @unique
  username  String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([username])
  @@index([expiresAt])
  @@map("admin_sessions")
}

// Active Users (for tracking)
model ActiveUser {
  id          String   @id @default(cuid())
  userId      String
  ipAddress   String?
  phoneNumber String?
  firstSeen   DateTime @default(now())
  lastSeen    DateTime @default(now())
  actionCount Int      @default(0)
  taskCount   Int      @default(0)

  @@unique([userId, ipAddress])
  @@index([lastSeen])
  @@map("active_users")
}

// Code Usage History
model CodeUsageHistory {
  id        String   @id @default(cuid())
  codeId    String
  userId    String
  tokensUsed Int     @default(1)
  timestamp DateTime @default(now())

  code      Code     @relation(fields: [codeId], references: [id])

  @@index([codeId])
  @@index([userId])
  @@map("code_usage_history")
}

